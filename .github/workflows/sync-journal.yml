# Workflow: fetch private journal entries, generate static HTML, push to this repo's docs/blog/
# Triggers: manual (workflow_dispatch) and schedule (daily). You can also trigger via repository_dispatch.
name: Sync Journal -> Site

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *' # every 6 hours; adjust as needed
  repository_dispatch: # optional: triggered by journal repo when it wants to notify this repo
    types: [journal-updated]

permissions:
  contents: write # allow workflow to commit to this repo

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout website repo (this repo)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout private journal repo
        uses: actions/checkout@v4
        with:
          repository: arkanemystic/journal
          path: journal
          token: ${{ secrets.JOURNAL_PAT }} # set this secret (see below)

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          npm ci

      - name: Generate static blog pages
        run: |
          node ./scripts/generate.js --src journal/entries --out docs/blog

      - name: Commit generated blog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/blog || true
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: update blog from private journal [ci skip]"
            git push
          fi